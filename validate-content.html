<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Validator - EW Bachelor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml/dist/js-yaml.min.js"></script>
  </head>
  <body
    class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 p-8"
  >
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">Content Validator</h1>

      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Validierung starten</h2>

        <!-- Study Selector -->
        <div class="mb-4">
          <label
            for="study-select"
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
          >
            Studiengang ausw√§hlen:
          </label>
          <select
            id="study-select"
            class="w-full md:w-auto px-4 py-2 border dark:border-gray-600 dark:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="">L√§dt...</option>
          </select>
        </div>

        <button
          id="validate-btn"
          class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-md transition duration-300"
        >
          Alle Content-Dateien validieren
        </button>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
          Pr√ºft alle Dateien im ausgew√§hlten Studiengang auf Fehler
        </p>
      </div>

      <div id="results" class="space-y-4"></div>
    </div>

    <script>
      let currentStudyId = '';

      // Load available studies
      async function loadStudies() {
        try {
          const response = await fetch('content/studies.json');
          if (!response.ok) throw new Error('Could not load studies');
          const studies = await response.json();

          const select = document.getElementById('study-select');
          select.innerHTML = '';

          for (const study of studies) {
            const option = document.createElement('option');
            option.value = study.id;
            option.textContent = `${study.icon || 'üìö'} ${study.title}`;
            select.appendChild(option);
          }

          // Set default
          if (studies.length > 0) {
            currentStudyId = studies[0].id;
            select.value = currentStudyId;
          }

          select.addEventListener('change', (e) => {
            currentStudyId = e.target.value;
          });
        } catch (error) {
          console.error('Error loading studies:', error);
          document.getElementById('study-select').innerHTML =
            '<option value="bsc-ernaehrungswissenschaften">BSc Ern√§hrungswissenschaften</option>';
          currentStudyId = 'bsc-ernaehrungswissenschaften';
        }
      }

      function getContentListPath() {
        return currentStudyId
          ? `content/${currentStudyId}/content-list.json`
          : 'content/content-list.json';
      }

      // Validation rules
      const REQUIRED_FIELDS = {
        'multiple-choice': ['type', 'question', 'options', 'correctAnswer'],
        'multiple-choice-multiple': [
          'type',
          'question',
          'options',
          'correctAnswers'
        ],
        'self-assessment-mc': ['type', 'question', 'options', 'correctAnswer'],
        'learning-content': ['type'],
        'youtube-video': ['type', 'url'],
        'external-video': ['type', 'url'],
        image: ['type', 'url', 'alt'],
        'mermaid-diagram': ['type'],
        'balance-equation': ['type', 'reactants', 'products'],
        achievement: ['type', 'id', 'title', 'description', 'unlockCondition']
      };

      async function validateAllContent() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML =
          '<div class="text-gray-600 dark:text-gray-400">Lade Content-Liste...</div>';

        try {
          // Load content list
          const contentListPath = getContentListPath();
          const response = await fetch(contentListPath);
          if (!response.ok) {
            throw new Error(`Konnte ${contentListPath} nicht laden`);
          }
          const contentList = await response.json();

          resultsDiv.innerHTML =
            '<div class="text-gray-600 dark:text-gray-400">Validiere ' +
            contentList.length +
            ' Dateien...</div>';

          const results = [];

          // Validate each file
          for (const filePath of contentList) {
            const result = await validateFile(filePath);
            results.push(result);
          }

          // Display results
          displayResults(results);
        } catch (error) {
          resultsDiv.innerHTML = `<div class="bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 dark:text-red-200 px-4 py-3 rounded">
                    <strong>Fehler:</strong> ${error.message}
                </div>`;
        }
      }

      async function validateFile(filePath) {
        const result = {
          file: filePath,
          errors: [],
          warnings: [],
          itemCount: 0
        };

        try {
          const response = await fetch(filePath);
          if (!response.ok) {
            result.errors.push(`Datei nicht gefunden oder nicht lesbar`);
            return result;
          }

          const content = await response.text();

          // Detect file type
          const isLectureMetadata =
            filePath.endsWith('/lecture.md') &&
            !filePath.includes('/lecture-items/');
          const isQuizMetadata =
            filePath.endsWith('/quiz.md') && !filePath.includes('/questions/');
          const isModuleMetadata = filePath.endsWith('/module.md');
          const isLectureItem = filePath.includes('/lecture-items/');
          const isQuizQuestion = filePath.includes('/questions/');

          // Parse multi-document format
          const documents = parseMultiDocument(content);
          result.itemCount = documents.length;

          // Validate based on file type
          if (isLectureMetadata) {
            validateLectureMetadata(documents[0], result);
          } else if (isQuizMetadata) {
            validateQuizMetadata(documents[0], result);
          } else if (isModuleMetadata) {
            validateModuleMetadata(documents[0], result);
          } else {
            // Validate each document as content item
            documents.forEach((doc, index) => {
              validateDocument(doc, index, result);
            });
          }
        } catch (error) {
          result.errors.push(`Fehler beim Lesen: ${error.message}`);
        }

        return result;
      }

      function validateLectureMetadata(doc, result) {
        if (doc.parseError) {
          result.errors.push(`YAML Parse-Fehler: ${doc.parseError}`);
          return;
        }

        const attrs = doc.attributes;

        // Check required metadata fields
        if (!attrs.topic) {
          result.errors.push(`Pflichtfeld 'topic' fehlt`);
        }
        if (!attrs.description) {
          result.errors.push(`Pflichtfeld 'description' fehlt`);
        }
      }

      function validateQuizMetadata(doc, result) {
        if (doc.parseError) {
          result.errors.push(`YAML Parse-Fehler: ${doc.parseError}`);
          return;
        }

        const attrs = doc.attributes;

        // Check required metadata fields
        if (!attrs.description) {
          result.errors.push(`Pflichtfeld 'description' fehlt`);
        }
      }

      function validateModuleMetadata(doc, result) {
        if (doc.parseError) {
          result.errors.push(`YAML Parse-Fehler: ${doc.parseError}`);
          return;
        }

        const attrs = doc.attributes;

        // Check required metadata fields for modules
        if (!attrs.id) {
          result.errors.push(`Pflichtfeld 'id' fehlt`);
        }
        if (!attrs.title) {
          result.errors.push(`Pflichtfeld 'title' fehlt`);
        }
      }

      function parseMultiDocument(content) {
        const documents = [];
        const parts = content.split(/^---$/m);

        if (parts[0] && parts[0].trim()) {
          documents.push({ attributes: {}, body: parts[0], raw: parts[0] });
        }

        for (let i = 1; i < parts.length; i += 2) {
          const frontmatterPart = parts[i];
          const bodyPart = i + 1 < parts.length ? parts[i + 1] : '';

          try {
            const attributes = jsyaml.load(frontmatterPart) || {};
            documents.push({
              attributes,
              body: bodyPart,
              raw: frontmatterPart
            });
          } catch (e) {
            documents.push({
              attributes: {},
              body: frontmatterPart,
              raw: frontmatterPart,
              parseError: e.message
            });
          }
        }

        return documents.filter(
          (d) =>
            (d.body && d.body.trim()) ||
            (d.attributes && Object.keys(d.attributes).length > 0)
        );
      }

      function validateDocument(doc, index, result) {
        const itemNum = index + 1;

        // Check for YAML parse errors
        if (doc.parseError) {
          result.errors.push(
            `Item ${itemNum}: YAML Parse-Fehler: ${doc.parseError}`
          );

          // Check for common mistakes
          if (doc.raw.includes("* '") || doc.raw.includes("*'")) {
            result.errors.push(
              `Item ${itemNum}: YAML-Liste verwendet '*' statt '-' (siehe Zeile mit Apostroph)`
            );
          }
          return;
        }

        const attrs = doc.attributes;

        // Skip items without type
        if (!attrs.type) {
          if (Object.keys(attrs).length > 0) {
            result.warnings.push(`Item ${itemNum}: Kein 'type' Feld gefunden`);
          }
          return;
        }

        // Check required fields for this type
        const requiredFields = REQUIRED_FIELDS[attrs.type];
        if (!requiredFields) {
          result.warnings.push(
            `Item ${itemNum}: Unbekannter Typ '${attrs.type}'`
          );
          return;
        }

        // Validate required fields
        requiredFields.forEach((field) => {
          if (!attrs[field]) {
            result.errors.push(
              `Item ${itemNum} (${attrs.type}): Pflichtfeld '${field}' fehlt`
            );
          }
        });

        // Validate options format for multiple-choice
        if (
          attrs.type.includes('multiple-choice') ||
          attrs.type.includes('self-assessment-mc')
        ) {
          if (attrs.options) {
            if (!Array.isArray(attrs.options)) {
              result.errors.push(
                `Item ${itemNum}: 'options' muss eine Liste sein`
              );
            } else if (attrs.options.length < 2) {
              result.errors.push(
                `Item ${itemNum}: Mindestens 2 Optionen erforderlich`
              );
            }

            // Check if correctAnswer is in options (single choice)
            if (attrs.correctAnswer && Array.isArray(attrs.options)) {
              if (!attrs.options.includes(attrs.correctAnswer)) {
                result.errors.push(
                  `Item ${itemNum}: 'correctAnswer' ist nicht in 'options' enthalten`
                );
              }
            }

            // Check if correctAnswers are in options (multiple choice)
            if (attrs.correctAnswers && Array.isArray(attrs.options)) {
              if (!Array.isArray(attrs.correctAnswers)) {
                result.errors.push(
                  `Item ${itemNum}: 'correctAnswers' muss eine Liste sein`
                );
              } else {
                attrs.correctAnswers.forEach((answer) => {
                  if (!attrs.options.includes(answer)) {
                    result.errors.push(
                      `Item ${itemNum}: correctAnswer '${answer}' ist nicht in 'options' enthalten`
                    );
                  }
                });
              }
            }
          }
        }

        // Check for asterisks in raw YAML (common mistake)
        if (doc.raw.includes("\n* '") || doc.raw.includes("\n*'")) {
          result.warnings.push(
            `Item ${itemNum}: M√∂glicherweise '*' statt '-' in YAML-Liste verwendet`
          );
        }
      }

      function displayResults(results) {
        const resultsDiv = document.getElementById('results');

        const totalErrors = results.reduce(
          (sum, r) => sum + r.errors.length,
          0
        );
        const totalWarnings = results.reduce(
          (sum, r) => sum + r.warnings.length,
          0
        );
        const totalItems = results.reduce((sum, r) => sum + r.itemCount, 0);

        let html = '';

        // Summary
        if (totalErrors === 0 && totalWarnings === 0) {
          html += `<div class="bg-green-100 dark:bg-green-900 border border-green-400 text-green-700 dark:text-green-200 px-4 py-3 rounded">
                    <strong>‚úì Alle Dateien sind valide!</strong><br>
                    ${results.length} Dateien gepr√ºft, ${totalItems} Items gefunden
                </div>`;
        } else {
          html += `<div class="bg-yellow-100 dark:bg-yellow-900 border border-yellow-400 text-yellow-700 dark:text-yellow-200 px-4 py-3 rounded">
                    <strong>Validierung abgeschlossen</strong><br>
                    ${results.length} Dateien gepr√ºft, ${totalItems} Items gefunden<br>
                    <span class="font-bold">${totalErrors} Fehler</span>, ${totalWarnings} Warnungen
                </div>`;
        }

        // Individual file results
        results.forEach((result) => {
          if (result.errors.length === 0 && result.warnings.length === 0) {
            html += `<div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 px-4 py-3 rounded">
                        <div class="flex items-center">
                            <span class="text-green-500 mr-2">‚úì</span>
                            <strong>${result.file}</strong>
                            <span class="ml-auto text-sm text-gray-500">${result.itemCount} Items</span>
                        </div>
                    </div>`;
          } else {
            const errorClass =
              result.errors.length > 0 ? 'border-red-400' : 'border-yellow-400';
            html += `<div class="bg-white dark:bg-gray-800 border ${errorClass} px-4 py-3 rounded">
                        <div class="flex items-center mb-2">
                            <span class="text-red-500 mr-2">${
                              result.errors.length > 0 ? '‚úó' : '‚ö†'
                            }</span>
                            <strong>${result.file}</strong>
                            <span class="ml-auto text-sm text-gray-500">${
                              result.itemCount
                            } Items</span>
                        </div>`;

            if (result.errors.length > 0) {
              html += '<div class="ml-6 space-y-1">';
              result.errors.forEach((error) => {
                html += `<div class="text-red-600 dark:text-red-400 text-sm">‚ùå ${error}</div>`;
              });
              html += '</div>';
            }

            if (result.warnings.length > 0) {
              html += '<div class="ml-6 space-y-1 mt-2">';
              result.warnings.forEach((warning) => {
                html += `<div class="text-yellow-600 dark:text-yellow-400 text-sm">‚ö†Ô∏è ${warning}</div>`;
              });
              html += '</div>';
            }

            html += '</div>';
          }
        });

        resultsDiv.innerHTML = html;
      }

      // Initialize
      loadStudies();

      // Event listener
      document
        .getElementById('validate-btn')
        .addEventListener('click', validateAllContent);
    </script>
  </body>
</html>
